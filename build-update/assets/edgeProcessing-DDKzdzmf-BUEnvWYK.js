import{z as It}from"./deduplicate-KcKkQhWf-CGLjlhGb.js";import{R as B}from"./InterleavedLayout-BMFLQBGy-BtioV1j6.js";import{T as l}from"./VertexAttribute-DqD5S0a2-3q90nikV.js";import{p as j}from"./glUtil-BonlLoq2-UWGwjh4A.js";import{cG as tt,cE as Ot,cH as H,cI as ot,cJ as J,cK as St,cL as At,cM as ht,cN as rt,cO as dt,cB as T,cP as pt,cC as Et,c9 as Tt,bV as wt}from"./story-DE9AooAy.js";const Mt=B().vec3f(l.POSITION).u16(l.COMPONENTINDEX).freeze(),Rt=B().vec2u8(l.SIDENESS).freeze();j(Rt);const Q=B().vec3f(l.POSITION0).vec3f(l.POSITION1).vec2i16(l.NORMALCOMPRESSED).u16(l.COMPONENTINDEX).u8(l.VARIANTOFFSET,{glNormalized:!0}).u8(l.VARIANTSTROKE).u8(l.VARIANTEXTENSION,{glNormalized:!0}).freeze(),Y=B().vec3f(l.POSITION0).vec3f(l.POSITION1).vec2i16(l.NORMALCOMPRESSED).vec2i16(l.NORMAL2COMPRESSED).u16(l.COMPONENTINDEX).u8(l.VARIANTOFFSET,{glNormalized:!0}).u8(l.VARIANTSTROKE).u8(l.VARIANTEXTENSION,{glNormalized:!0}).freeze();l.POSITION0,l.POSITION1,l.COMPONENTINDEX,l.VARIANTOFFSET,l.VARIANTSTROKE,l.VARIANTEXTENSION,l.NORMALCOMPRESSED,l.NORMAL2COMPRESSED,l.SIDENESS;let yt=class{constructor(){this.position0=T(),this.position1=T(),this.faceNormal0=T(),this.faceNormal1=T(),this.componentIndex=0,this.cosAngle=0}};const K=-1;function Pt(t,n,s){const r=t.vertices.position,c=t.vertices.componentIndex,i=O.position0,d=O.position1,g=O.faceNormal0,m=O.faceNormal1,{edges:a,normals:h}=Dt(t),N=a.length/4,A=n.allocate(N);let v=0;const F=N,w=s?.allocate(F);let z=0,e=0,o=0;X.length=0;for(let p=0;p<N;++p){const R=4*p;r.getVec(a.data[R],i),r.getVec(a.data[R+1],d);const D=X.pushNew();D.index=4*p,D.length=Ot(i,d)}X.sort((p,R)=>R.length-p.length);const f=new Array,u=new Array;X.forAll(({length:p,index:R})=>{const D=a.data[R],mt=a.data[R+1],et=a.data[R+2],nt=a.data[R+3],st=nt===K;if(r.getVec(D,i),r.getVec(mt,d),st){const E=3*et;H(g,h.data[E],h.data[E+1],h.data[E+2]),ot(m,g),O.componentIndex=c.get(D),O.cosAngle=J(g,m)}else{let E=3*et;if(H(g,h.data[E],h.data[E+1],h.data[E+2]),E=3*nt,H(m,h.data[E],h.data[E+1],h.data[E+2]),O.componentIndex=c.get(D),O.cosAngle=J(g,m),vt(O,xt))return;O.cosAngle<-.9999&&ot(m,g)}e+=p,o++,st||Vt(O,Ft)?(n.write(A,v++,O),f.push(p)):Ct(O,gt)&&(w&&s&&s.write(w,z++,O),u.push(p))});const S=new Float32Array(f.reverse()),M=new Float32Array(u.reverse()),y=w&&s?{instancesData:w.slice(0,z),lodInfo:{lengths:M}}:void 0;return{regular:{instancesData:A.slice(0,v),lodInfo:{lengths:S}},silhouette:y,averageEdgeLength:e/o}}function Vt(t,n){return t.cosAngle<n}function vt(t,n){return t.cosAngle>n}function Ct(t,n){const s=St(t.cosAngle);return At(ct,t.position1,t.position0),s*(J(ht(bt,t.faceNormal0,t.faceNormal1),ct)>0?-1:1)>n}function Dt(t){const n=t.faces.length/3,s=t.faces,r=t.neighbors,c=t.vertices.position;I.length=k.length=0;for(let i=0;i<n;i++){const d=3*i,g=r[d],m=r[d+1],a=r[d+2],h=s[d],N=s[d+1],A=s[d+2];c.getVec(h,C),c.getVec(N,U),c.getVec(A,_),rt(U,U,C),rt(_,_,C),ht(C,U,_),dt(C,C),k.pushArray(C),(g===K||h<N)&&(I.push(h),I.push(N),I.push(i),I.push(g)),(m===K||N<A)&&(I.push(N),I.push(A),I.push(i),I.push(m)),(a===K||A<h)&&(I.push(A),I.push(h),I.push(i),I.push(a))}return{edges:I,normals:k}}class Lt{constructor(){this.index=0,this.length=0}}const X=new tt({allocator:t=>t||new Lt,deallocator:null}),I=new tt({deallocator:null}),k=new tt({deallocator:null}),O=new yt,bt=T(),ct=T(),C=T(),U=T(),_=T(),gt=pt(4),xt=Math.cos(gt),Bt=pt(35),Ft=Math.cos(Bt);function at(t,n,s){const r=n/3,c=new Uint32Array(s+1),i=new Uint32Array(s+1),d=(e,o)=>{e<o?c[e+1]++:i[o+1]++};for(let e=0;e<r;e++){const o=t[3*e],f=t[3*e+1],u=t[3*e+2];d(o,f),d(f,u),d(u,o)}let g=0,m=0;for(let e=0;e<s;e++){const o=c[e+1],f=i[e+1];c[e+1]=g,i[e+1]=m,g+=o,m+=f}const a=new Uint32Array(6*r),h=c[s],N=(e,o,f)=>{if(e<o){const u=c[e+1]++;a[2*u]=o,a[2*u+1]=f}else{const u=i[o+1]++;a[2*h+2*u]=e,a[2*h+2*u+1]=f}};for(let e=0;e<r;e++){const o=t[3*e],f=t[3*e+1],u=t[3*e+2];N(o,f,e),N(f,u,e),N(u,o,e)}const A=(e,o)=>{const f=2*e,u=o-e;for(let S=1;S<u;S++){const M=a[f+2*S],y=a[f+2*S+1];let p=S-1;for(;p>=0&&a[f+2*p]>M;p--)a[f+2*p+2]=a[f+2*p],a[f+2*p+3]=a[f+2*p+1];a[f+2*p+2]=M,a[f+2*p+3]=y}};for(let e=0;e<s;e++)A(c[e],c[e+1]),A(h+i[e],h+i[e+1]);const v=new Int32Array(3*r),F=(e,o)=>e===t[3*o]?0:e===t[3*o+1]?1:e===t[3*o+2]?2:-1,w=(e,o)=>{const f=F(e,o);v[3*o+f]=-1},z=(e,o,f,u)=>{const S=F(e,o);v[3*o+S]=u;const M=F(f,u);v[3*u+M]=o};for(let e=0;e<s;e++){let o=c[e];const f=c[e+1];let u=i[e];const S=i[e+1];for(;o<f&&u<S;){const M=a[2*o],y=a[2*h+2*u];M===y?(z(e,a[2*o+1],y,a[2*h+2*u+1]),o++,u++):M<y?(w(e,a[2*o+1]),o++):(w(y,a[2*h+2*u+1]),u++)}for(;o<f;)w(e,a[2*o+1]),o++;for(;u<S;)w(a[2*h+2*u],a[2*h+2*u+1]),u++}return v}function q(t,n,s,r,c,i=2){const d=1/(Math.abs(s)+Math.abs(r)+Math.abs(c)),g=s*d,m=r*d,a=c<=0?(g>=0?1:-1)*(1-Math.abs(m)):g,h=c<=0?(m>=0?1:-1)*(1-Math.abs(g)):m,N=n*i;t[N]=it(a),t[N+1]=it(h)}function it(t){return Tt(Math.round(32767*t),-32767,32767)}const G=.7;let Nt=class{updateSettings(t){this.settings=t,this._edgeHashFunction=t.reducedPrecision?Xt:zt}write(t,n,s){W.seed=this._edgeHashFunction(s);const r=W.getIntRange(0,255),c=W.getIntRange(0,this.settings.variants-1),i=W.getFloat(),d=255*(.5*Ut(-(1-Math.min(i/G,1))+Math.max(0,i-G)/(1-G),1.2)+.5);t.position0.setVec(n,s.position0),t.position1.setVec(n,s.position1),t.componentIndex.set(n,s.componentIndex),t.variantOffset.set(n,r),t.variantStroke.set(n,c),t.variantExtension.set(n,d)}};const P=new Float32Array(6),V=new Uint32Array(P.buffer),x=new Uint32Array(1);function zt(t){return P[0]=t.position0[0],P[1]=t.position0[1],P[2]=t.position0[2],P[3]=t.position1[0],P[4]=t.position1[1],P[5]=t.position1[2],x[0]=31*(31*(31*(31*(31*(166811+V[0])+V[1])+V[2])+V[3])+V[4])+V[5],x[0]}function Xt(t){const n=P;n[0]=L(t.position0[0]),n[1]=L(t.position0[1]),n[2]=L(t.position0[2]),n[3]=L(t.position1[0]),n[4]=L(t.position1[1]),n[5]=L(t.position1[2]),x[0]=5381;for(let s=0;s<V.length;s++)x[0]=31*x[0]+V[s];return x[0]}const lt=1e4;function L(t){return Math.round(t*lt)/lt}function Ut(t,n){return Math.abs(t)**n*Math.sign(t)}class Z{constructor(){this._commonWriter=new Nt}updateSettings(n){this._commonWriter.updateSettings(n)}allocate(n){return Q.createBuffer(n)}write(n,s,r){this._commonWriter.write(n,s,r),Et(b,r.faceNormal0,r.faceNormal1),dt(b,b);const{typedBuffer:c,typedBufferStride:i}=n.normalCompressed;q(c,s,b[0],b[1],b[2],i)}}Z.Layout=Q,Z.glLayout=j(Q,1);class ${constructor(){this._commonWriter=new Nt}updateSettings(n){this._commonWriter.updateSettings(n)}allocate(n){return Y.createBuffer(n)}write(n,s,r){this._commonWriter.write(n,s,r);{const{typedBuffer:c,typedBufferStride:i}=n.normalCompressed;q(c,s,r.faceNormal0[0],r.faceNormal0[1],r.faceNormal0[2],i)}{const{typedBuffer:c,typedBufferStride:i}=n.normal2Compressed;q(c,s,r.faceNormal1[0],r.faceNormal1[1],r.faceNormal1[2],i)}}}$.Layout=Y,$.glLayout=j(Y,1);const b=T(),W=new wt;function Qt(t){const n=_t(t.data,t.skipDeduplicate,t.indices,t.indicesLength);return ut.updateSettings(t.writerSettings),ft.updateSettings(t.writerSettings),Pt(n,ut,ft)}function _t(t,n,s,r){if(n){const d=at(s,r,t.count);return new Wt(s,r,d,t)}const c=It(t.buffer,t.stride/4,{originalIndices:s,originalIndicesLength:r}),i=at(c.indices,r,c.uniqueCount);return{faces:c.indices,facesLength:c.indices.length,neighbors:i,vertices:Mt.createView(c.buffer)}}class Wt{constructor(n,s,r,c){this.faces=n,this.facesLength=s,this.neighbors=r,this.vertices=c}}const ut=new Z,ft=new $,Yt=B().vec3f(l.POSITION0).vec3f(l.POSITION1),qt=B().vec3f(l.POSITION0).vec3f(l.POSITION1).u16(l.COMPONENTINDEX);export{Yt as K,Qt as W,qt as k,Mt as l,_t as m,Pt as u};
