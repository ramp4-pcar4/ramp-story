import{fR as Oe,cG as C,cI as Y,ik as me,cB as F,eb as Re,ed as Ae,h9 as be,cH as pe,ig as N,hg as $,cC as k,ij as Z,gY as O}from"./story-DE9AooAy.js";import{B as he,_ as ee,C as y,l as te,a as J,Q as ne,z as T,S as I}from"./sphere-_Zcui0FU-CoSuXPKk.js";import{B as b,$ as Fe,e as Ee,z as ge,G as H}from"./plane-B2J4G_40-YEDqrpJy.js";import{g as ae}from"./Util-cAlFLh9R-CyPLXCS2.js";function le(o){return o?{ray:ee(o.ray),c0:o.c0,c1:o.c1}:{ray:ee(),c0:0,c1:Number.MAX_VALUE}}new he(()=>le());function $e(o){return o?[b(o[0]),b(o[1]),b(o[2]),b(o[3]),b(o[4]),b(o[5])]:[b(),b(),b(),b(),b(),b()]}function Be(){return[F(),F(),F(),F(),F(),F(),F(),F()]}function ke(o,e){for(let t=0;t<de;t++)Fe(o[t],e[t]);return o}function Je(o,e,t,n=xe){const s=Re(Ee.get(),e,o);Ae(s,s);for(let r=0;r<Se;++r){const a=be(ge.get(),Me[r],s);pe(n[r],a[0]/a[3],a[1]/a[3],a[2]/a[3])}Ne(t,n)}function Ne(o,e){H(e[i.FAR_BOTTOM_LEFT],e[i.NEAR_BOTTOM_LEFT],e[i.NEAR_TOP_LEFT],o[S.LEFT]),H(e[i.NEAR_BOTTOM_RIGHT],e[i.FAR_BOTTOM_RIGHT],e[i.FAR_TOP_RIGHT],o[S.RIGHT]),H(e[i.FAR_BOTTOM_LEFT],e[i.FAR_BOTTOM_RIGHT],e[i.NEAR_BOTTOM_RIGHT],o[S.BOTTOM]),H(e[i.NEAR_TOP_LEFT],e[i.NEAR_TOP_RIGHT],e[i.FAR_TOP_RIGHT],o[S.TOP]),H(e[i.NEAR_BOTTOM_LEFT],e[i.NEAR_BOTTOM_RIGHT],e[i.NEAR_TOP_RIGHT],o[S.NEAR]),H(e[i.FAR_BOTTOM_RIGHT],e[i.FAR_BOTTOM_LEFT],e[i.FAR_TOP_LEFT],o[S.FAR])}function v(o,e){for(let t=0;t<de;t++){const n=o[t];if(n[0]*e[0]+n[1]*e[1]+n[2]*e[2]+n[3]>=e[3])return!1}return!0}var S,i;(function(o){o[o.LEFT=0]="LEFT",o[o.RIGHT=1]="RIGHT",o[o.BOTTOM=2]="BOTTOM",o[o.TOP=3]="TOP",o[o.NEAR=4]="NEAR",o[o.FAR=5]="FAR"})(S||(S={})),function(o){o[o.NEAR_BOTTOM_LEFT=0]="NEAR_BOTTOM_LEFT",o[o.NEAR_BOTTOM_RIGHT=1]="NEAR_BOTTOM_RIGHT",o[o.NEAR_TOP_RIGHT=2]="NEAR_TOP_RIGHT",o[o.NEAR_TOP_LEFT=3]="NEAR_TOP_LEFT",o[o.FAR_BOTTOM_LEFT=4]="FAR_BOTTOM_LEFT",o[o.FAR_BOTTOM_RIGHT=5]="FAR_BOTTOM_RIGHT",o[o.FAR_TOP_RIGHT=6]="FAR_TOP_RIGHT",o[o.FAR_TOP_LEFT=7]="FAR_TOP_LEFT"}(i||(i={})),i.FAR_BOTTOM_RIGHT,i.NEAR_BOTTOM_RIGHT,i.NEAR_BOTTOM_LEFT,i.FAR_BOTTOM_LEFT,i.NEAR_BOTTOM_LEFT,i.NEAR_BOTTOM_RIGHT,i.NEAR_TOP_RIGHT,i.NEAR_TOP_LEFT,i.FAR_BOTTOM_RIGHT,i.FAR_BOTTOM_LEFT,i.FAR_TOP_LEFT,i.FAR_TOP_RIGHT,i.NEAR_BOTTOM_RIGHT,i.FAR_BOTTOM_RIGHT,i.FAR_TOP_RIGHT,i.NEAR_TOP_RIGHT,i.FAR_BOTTOM_LEFT,i.NEAR_BOTTOM_LEFT,i.NEAR_TOP_LEFT,i.FAR_TOP_LEFT,i.FAR_TOP_LEFT,i.NEAR_TOP_LEFT,i.NEAR_TOP_RIGHT,i.FAR_TOP_RIGHT;const de=6,Se=8,Me=[N(-1,-1,-1,1),N(1,-1,-1,1),N(1,1,-1,1),N(-1,1,-1,1),N(-1,-1,1,1),N(1,-1,1,1),N(1,1,1,1),N(-1,1,1,1)];new he(le);const xe=Be();class z{get bounds(){return this._root.bounds}get halfSize(){return this._root.halfSize}get root(){return this._root.node}get maximumObjectsPerNode(){return this._maximumObjectsPerNode}get maximumDepth(){return this._maximumDepth}get objectCount(){return this._objectCount}constructor(e,t){this.objectToBoundingSphere=e,this._maximumObjectsPerNode=10,this._maximumDepth=20,this._degenerateObjects=new Set,this._root=new l,this._objectCount=0,t&&(t.maximumObjectsPerNode!==void 0&&(this._maximumObjectsPerNode=t.maximumObjectsPerNode),t.maximumDepth!==void 0&&(this._maximumDepth=t.maximumDepth))}destroy(){this._degenerateObjects.clear(),l.clearPool(),X[0]=null,j.prune(),P.prune()}add(e,t=e.length){this._objectCount+=t,this._grow(e,t);const n=l.acquire();for(let s=0;s<t;s++){const r=e[s];this._isDegenerate(r)?this._degenerateObjects.add(r):(n.init(this._root),this._add(r,n))}l.release(n)}remove(e,t=null){this._objectCount-=e.length;const n=l.acquire();for(const s of e){const r=t??y(this.objectToBoundingSphere(s),Ce);D(r[3])?(n.init(this._root),je(s,r,n)):this._degenerateObjects.delete(s)}l.release(n),this._shrink()}update(e,t){if(!D(t[3])&&this._isDegenerate(e))return;const n=De(e);this.remove(n,t),this.add(n)}forEachAlongRay(e,t,n){const s=te(e,t);x(this._root,r=>{if(!ze(s,r))return!1;const a=r.node;return a.terminals.forAll(u=>{this._intersectsObject(s,u)&&n(u)}),a.residents!==null&&a.residents.forAll(u=>{this._intersectsObject(s,u)&&n(u)}),!0})}forEachAlongRayWithVerticalOffset(e,t,n,s){const r=te(e,t);x(this._root,a=>{if(!He(r,a,s))return!1;const u=a.node;return u.terminals.forAll(h=>{this._intersectsObjectWithOffset(r,h,s)&&n(h)}),u.residents!==null&&u.residents.forAll(h=>{this._intersectsObjectWithOffset(r,h,s)&&n(h)}),!0})}forEach(e){x(this._root,t=>{const n=t.node;return n.terminals.forAll(e),n.residents!==null&&n.residents.forAll(e),!0}),this._degenerateObjects.forEach(e)}forEachDegenerateObject(e){this._degenerateObjects.forEach(e)}findClosest(e,t,n,s=()=>!0,r=1/0){let a=1/0,u=1/0,h=null;const c=K(e,t),f=d=>{if(--r,!s(d))return;const m=this.objectToBoundingSphere(d);if(!v(n,m))return;const E=M(e,t,T(m)),G=E-m[3],_=E+m[3];G<a&&(a=G,u=_,h=d)};return oe(this._root,d=>{if(r<=0||!v(n,d.bounds)||($(p,c,d.halfSize),k(p,p,T(d.bounds)),M(e,t,p)>u))return!1;const m=d.node;return m.terminals.forAll(E=>f(E)),m.residents!==null&&m.residents.forAll(E=>f(E)),!0},e,t),h}forEachInDepthRange(e,t,n,s,r,a,u){let h=-1/0,c=1/0;const f={setRange:_=>{n===z.DepthOrder.FRONT_TO_BACK?(h=Math.max(h,_.near),c=Math.min(c,_.far)):(h=Math.max(h,-_.far),c=Math.min(c,-_.near))}};f.setRange(s);const d=M(t,n,e),m=K(t,n),E=K(t,-n),G=_=>{if(!u(_))return;const B=this.objectToBoundingSphere(_),L=T(B),Q=M(t,n,L)-d,Te=Q-B[3],fe=Q+B[3];Te>c||fe<h||!v(a,B)||r(_,f)};oe(this._root,_=>{if(!v(a,_.bounds)||($(p,m,_.halfSize),k(p,p,T(_.bounds)),M(t,n,p)-d>c)||($(p,E,_.halfSize),k(p,p,T(_.bounds)),M(t,n,p)-d<h))return!1;const B=_.node;return B.terminals.forAll(L=>G(L)),B.residents!==null&&B.residents.forAll(L=>G(L)),!0},t,n)}forEachNode(e){x(this._root,t=>e(t.node,t.bounds,t.halfSize,t.depth))}forEachNeighbor(e,t){const n=J(t),s=T(t),r=h=>{const c=this.objectToBoundingSphere(h),f=J(c),d=n+f;return!(Z(T(c),s)-d*d<=0)||e(h)};let a=!0;const u=h=>{a&&(a=r(h))};x(this._root,h=>{const c=J(h.bounds),f=n+c;if(Z(T(h.bounds),s)-f*f>0)return!1;const d=h.node;return d.terminals.forAll(u),a&&d.residents!==null&&d.residents.forAll(u),a}),a&&this.forEachDegenerateObject(u)}_intersectsObject(e,t){const n=this.objectToBoundingSphere(t);return!(n[3]>0)||ne(n,e)}_intersectsObjectWithOffset(e,t,n){const s=this.objectToBoundingSphere(t);return!(s[3]>0)||ne(n.applyToBoundingSphere(s),e)}_add(e,t){t.advanceTo(this.objectToBoundingSphere(e))?t.node.terminals.push(e):(t.node.residents.push(e),t.node.residents.length>this._maximumObjectsPerNode&&t.depth<this._maximumDepth&&this._split(t))}_split(e){const t=e.node.residents;e.node.residents=null;for(let n=0;n<t.length;n++){const s=l.acquire().init(e);this._add(t.at(n),s),l.release(s)}}_grow(e,t){if(t!==0&&(se(e,t,n=>this.objectToBoundingSphere(n),g),D(g[3])&&!this._fitsInsideTree(g)))if(ue(this._root.node))y(g,this._root.bounds),this._root.halfSize=1.25*this._root.bounds[3],this._root.updateBoundsRadiusFromHalfSize();else{const n=this._rootBoundsForRootAsSubNode(g);this._placingRootViolatesMaxDepth(n)?this._rebuildTree(g,n):this._growRootAsSubNode(n),l.release(n)}}_rebuildTree(e,t){Y(T(V),T(t.bounds)),V[3]=t.halfSize,se([e,V],2,s=>s,W);const n=l.acquire().init(this._root);this._root.initFrom(null,W,W[3]),this._root.increaseHalfSize(1.25),x(n,s=>(this.add(s.node.terminals.data,s.node.terminals.length),s.node.residents!==null&&this.add(s.node.residents.data,s.node.residents.length),!0)),l.release(n)}_placingRootViolatesMaxDepth(e){const t=Math.log(e.halfSize/this._root.halfSize)*Math.LOG2E;let n=0;return x(this._root,s=>(n=Math.max(n,s.depth),n+t<=this._maximumDepth)),n+t>this._maximumDepth}_rootBoundsForRootAsSubNode(e){const t=e[3],n=e;let s=-1/0;const r=this._root.bounds,a=this._root.halfSize;for(let h=0;h<3;h++){const c=r[h]-a-(n[h]-t),f=n[h]+t-(r[h]+a),d=Math.max(0,Math.ceil(c/(2*a))),m=Math.max(0,Math.ceil(f/(2*a)))+1,E=2**Math.ceil(Math.log(d+m)*Math.LOG2E);s=Math.max(s,E),w[h].min=d,w[h].max=m}for(let h=0;h<3;h++){let c=w[h].min,f=w[h].max;const d=(s-(c+f))/2;c+=Math.ceil(d),f+=Math.floor(d);const m=r[h]-a-c*a*2;U[h]=m+(f+c)*a}const u=s*a;return U[3]=u*_e,l.acquire().initFrom(null,U,u,0)}_growRootAsSubNode(e){const t=this._root.node;Y(T(g),T(this._root.bounds)),g[3]=this._root.halfSize,this._root.init(e),e.advanceTo(g,null,!0),e.node.children=t.children,e.node.residents=t.residents,e.node.terminals=t.terminals}_shrink(){for(;;){const e=this._findShrinkIndex();if(e===-1)break;this._root.advance(e),this._root.depth=0}}_findShrinkIndex(){if(this._root.node.terminals.length!==0||this._root.isLeaf())return-1;let e=null;const t=this._root.node.children;let n=0,s=0;for(;s<t.length&&e==null;)n=s++,e=t[n];for(;s<t.length;)if(t[s++])return-1;return n}_isDegenerate(e){return!D(this.objectToBoundingSphere(e)[3])}_fitsInsideTree(e){const t=this._root.bounds,n=this._root.halfSize;return e[3]<=n&&e[0]>=t[0]-n&&e[0]<=t[0]+n&&e[1]>=t[1]-n&&e[1]<=t[1]+n&&e[2]>=t[2]-n&&e[2]<=t[2]+n}toJSON(){const{maximumDepth:e,maximumObjectsPerNode:t,_objectCount:n}=this,s=this._nodeToJSON(this._root.node);return{maximumDepth:e,maximumObjectsPerNode:t,objectCount:n,root:{bounds:this._root.bounds,halfSize:this._root.halfSize,depth:this._root.depth,node:s}}}_nodeToJSON(e){const t=e.children.map(r=>r?this._nodeToJSON(r):null),n=e.residents?.map(r=>this.objectToBoundingSphere(r)),s=e.terminals?.map(r=>this.objectToBoundingSphere(r));return{children:t,residents:n,terminals:s}}static fromJSON(e){const t=new z(n=>n,{maximumDepth:e.maximumDepth,maximumObjectsPerNode:e.maximumObjectsPerNode});return t._objectCount=e.objectCount,t._root.initFrom(e.root.node,e.root.bounds,e.root.halfSize,e.root.depth),t}}class l{constructor(){this.bounds=I(),this.halfSize=0,this.initFrom(null,null,0,0)}init(e){return this.initFrom(e.node,e.bounds,e.halfSize,e.depth)}initFrom(e,t,n,s=this.depth){return this.node=e??l.createEmptyNode(),t&&y(t,this.bounds),this.halfSize=n,this.depth=s,this}increaseHalfSize(e){this.halfSize*=e,this.updateBoundsRadiusFromHalfSize()}updateBoundsRadiusFromHalfSize(){this.bounds[3]=this.halfSize*_e}advance(e){let t=this.node.children[e];t||(t=l.createEmptyNode(),this.node.children[e]=t),this.node=t,this.halfSize/=2,this.depth++;const n=ce[e];return this.bounds[0]+=n[0]*this.halfSize,this.bounds[1]+=n[1]*this.halfSize,this.bounds[2]+=n[2]*this.halfSize,this.updateBoundsRadiusFromHalfSize(),this}advanceTo(e,t,n=!1){for(;;){if(this.isTerminalFor(e))return t&&t(this,-1),!0;if(this.isLeaf()){if(!n)return t&&t(this,-1),!1;this.node.residents=null}const s=this._childIndex(e);t&&t(this,s),this.advance(s)}}isLeaf(){return this.node.residents!=null}isTerminalFor(e){return e[3]>this.halfSize/2}_childIndex(e){const t=this.bounds;return(t[0]<e[0]?1:0)+(t[1]<e[1]?2:0)+(t[2]<e[2]?4:0)}static createEmptyNode(){return{children:[null,null,null,null,null,null,null,null],terminals:new C({shrink:!0}),residents:new C({shrink:!0})}}static acquire(){return l._pool.acquire()}static release(e){l._pool.release(e)}static clearPool(){l._pool.prune()}}function x(o,e){let t=l.acquire().init(o);const n=[t];for(;n.length!==0;){if(t=n.pop(),e(t)&&!t.isLeaf())for(let s=0;s<t.node.children.length;s++)t.node.children[s]&&n.push(l.acquire().init(t).advance(s));l.release(t)}}function oe(o,e,t,n=z.DepthOrder.FRONT_TO_BACK){let s=l.acquire().init(o);const r=[s];for(Le(t,n,ie);r.length!==0;){if(s=r.pop(),e(s)&&!s.isLeaf())for(let a=7;a>=0;--a){const u=ie[a];s.node.children[u]&&r.push(l.acquire().init(s).advance(u))}l.release(s)}}function je(o,e,t){j.clear();const n=t.advanceTo(e,(s,r)=>{j.push(s.node),j.push(r)})?t.node.terminals:t.node.residents;if(n.removeUnordered(o),n.length===0)for(let s=j.length-2;s>=0&&Pe(j.data[s],j.data[s+1]);s-=2);}function Pe(o,e){return e>=0&&(o.children[e]=null),!!ue(o)&&(o.residents===null&&(o.residents=new C({shrink:!0})),!0)}function ze(o,e){return q(T(e.bounds),2*-e.halfSize,R),q(T(e.bounds),2*e.halfSize,A),ae(o.origin,o.direction,R,A)}function He(o,e,t){return q(T(e.bounds),2*-e.halfSize,R),q(T(e.bounds),2*e.halfSize,A),t.applyToMinMax(R,A),ae(o.origin,o.direction,R,A)}function ue(o){if(o.terminals.length!==0)return!1;if(o.residents!==null)return o.residents.length===0;for(let e=0;e<o.children.length;e++)if(o.children[e])return!1;return!0}function Ie(o,e){o[0]=Math.min(o[0],e[0]-e[3]),o[1]=Math.min(o[1],e[1]-e[3]),o[2]=Math.min(o[2],e[2]-e[3])}function Ge(o,e){o[0]=Math.max(o[0],e[0]+e[3]),o[1]=Math.max(o[1],e[1]+e[3]),o[2]=Math.max(o[2],e[2]+e[3])}function q(o,e,t){t[0]=o[0]+e,t[1]=o[1]+e,t[2]=o[2]+e}function se(o,e,t,n){if(e===1){const s=t(o[0]);y(s,n)}else{R[0]=1/0,R[1]=1/0,R[2]=1/0,A[0]=-1/0,A[1]=-1/0,A[2]=-1/0;for(let s=0;s<e;s++){const r=t(o[s]);D(r[3])&&(Ie(R,r),Ge(A,r))}me(T(n),R,A,.5),n[3]=Math.max(A[0]-R[0],A[1]-R[1],A[2]-R[2])/2}}function Le(o,e,t){if(!P.length)for(let n=0;n<8;++n)P.push({index:0,distance:0});for(let n=0;n<8;++n){const s=ce[n];P.data[n].index=n,P.data[n].distance=M(o,e,s)}P.sort((n,s)=>n.distance-s.distance);for(let n=0;n<8;++n)t[n]=P.data[n].index}function K(o,e){let t,n=1/0;for(let s=0;s<8;++s){const r=M(o,e,re[s]);r<n&&(n=r,t=re[s])}return t}function M(o,e,t){return e*(o[0]*t[0]+o[1]*t[1]+o[2]*t[2])}function D(o){return!isNaN(o)&&o!==-1/0&&o!==1/0&&o>0}l._pool=new Oe(l),function(o){var e;(e=o.DepthOrder||(o.DepthOrder={}))[e.FRONT_TO_BACK=1]="FRONT_TO_BACK",e[e.BACK_TO_FRONT=-1]="BACK_TO_FRONT"}(z||(z={}));const ce=[O(-1,-1,-1),O(1,-1,-1),O(-1,1,-1),O(1,1,-1),O(-1,-1,1),O(1,-1,1),O(-1,1,1),O(1,1,1)],re=[O(-1,-1,-1),O(-1,-1,1),O(-1,1,-1),O(-1,1,1),O(1,-1,-1),O(1,-1,1),O(1,1,-1),O(1,1,1)],_e=Math.sqrt(3),X=[null];function De(o){return X[0]=o,X}const U=I(),p=F(),R=F(),A=F(),j=new C,Ce=I(),g=I(),V=I(),W=I(),w=[{min:0,max:0},{min:0,max:0},{min:0,max:0}],P=new C,ie=[0,0,0,0,0,0,0,0],Ke=z;export{Je as B,ke as S,$e as g,Ke as y};
