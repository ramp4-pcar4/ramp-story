import{e8 as un,e9 as cn,ea as I,eb as $,ec as K,ed as v,ee as b,ef as fn,eg as pn,eh as mn,cB as L,ck as X,cQ as J,ei as nn,ej as q,ek as An,cO as Tn,el as gn,em as yn,en as Rn,Q as En,cN as dn,eo as Nn,ep as On}from"./story-u82SUoyt.js";import{n as rn}from"./mat3f64-Dh9_zhFu-BIT-k8Dm.js";import{u as en,t as x}from"./mat4f64-Dn1WEGBx-C99QVUMW.js";import{d as tn,m as Fn}from"./spatialReferenceEllipsoidUtils-a1l2O8Wm-BmysMxF9.js";import{G as P}from"./computeTranslationToOriginAndRotation-DlPeD1c9-C88kET92.js";import{u as Q}from"./projectPointToVector-D1BQGAFG-DqQVROWc.js";import{t as Pn,y as _n}from"./meshVertexSpaceUtils-VVkhP71b-BcqfT28l.js";import{P as S,b as D,z as V,O as on}from"./vec3-DeYubiaN-D3RW1UAQ.js";import{l as N,m as O}from"./BufferView-BDYk8Sh_-DwYlLv74.js";import{G as Cn}from"./vec4-DamUQeRS-CGfCsF6l.js";const er="Projection may be possible after calling projection.load().";function y(n,r,e,t){n.error(`Failed to project from (wkid:${r.wkid}) to (wkid:${e.wkid}).${t?" ":""}${t}`)}function Sn(n,r,e,t,o,l){return M(d.TO_PCPF,N.fromTypedArray(n),E.NORMAL,O.fromTypedArray(r),e,O.fromTypedArray(t),o,N.fromTypedArray(l))?l:null}function wn(n,r,e,t,o,l){return M(d.FROM_PCPF,N.fromTypedArray(n),E.NORMAL,O.fromTypedArray(r),e,O.fromTypedArray(t),o,N.fromTypedArray(l))?l:null}function Gn(n,r,e,t){return X(n,r,0,e,t,0)?e:null}function hn(n,r,e,t){return X(n,r,0,e,t,0)?e:null}function an(n,r,e){return b(f,e),V(r,n,f),J(f)&&on(r,r),r}function ln(n,r,e){return nn(f,e),Cn(r,n,f),J(f)&&on(r,r,4),r}function vn(n,r,e,t,o,l){if(!M(d.TO_PCPF,N.fromTypedArray(n,4*Float32Array.BYTES_PER_ELEMENT),E.TANGENT,O.fromTypedArray(r),e,O.fromTypedArray(t),o,N.fromTypedArray(l,4*Float32Array.BYTES_PER_ELEMENT)))return null;for(let a=3;a<n.length;a+=4)l[a]=n[a];return l}function xn(n,r,e,t,o,l){if(!M(d.FROM_PCPF,N.fromTypedArray(n,16),E.TANGENT,O.fromTypedArray(r),e,O.fromTypedArray(t),o,N.fromTypedArray(l,16)))return null;for(let a=3;a<n.length;a+=4)l[a]=n[a];return l}var E,d;function z(n,r,e,t,o){switch(P(t,e,_,t),n===d.FROM_PCPF&&v(_,_),r){case E.NORMAL:return b(o,_);case E.TANGENT:return nn(o,_)}}function M(n,r,e,t,o,l,a,i){if(!r)return;const c=t.count;if(Mn(o))for(let s=0;s<c;s++)l.getVec(s,h),r.getVec(s,g),q(g,g,z(n,e,h,a,f)),i.setVec(s,g);else for(let s=0;s<c;s++){l.getVec(s,h),r.getVec(s,g);const p=An(t.get(s,1));let u=Math.cos(p);e===E.TANGENT!=(n===d.TO_PCPF)&&(u=1/u),z(n,e,h,a,f),n===d.TO_PCPF?(f[0]*=u,f[1]*=u,f[2]*=u,f[3]*=u,f[4]*=u,f[5]*=u):(f[0]*=u,f[3]*=u,f[6]*=u,f[1]*=u,f[4]*=u,f[7]*=u),q(g,g,f),Tn(g,g),i.setVec(s,g)}return i}function Mn(n){return n.isWGS84||gn(n)||yn(n)||Rn(n)}(function(n){n[n.NORMAL=0]="NORMAL",n[n.TANGENT=1]="TANGENT"})(E||(E={})),function(n){n[n.TO_PCPF=0]="TO_PCPF",n[n.FROM_PCPF=1]="FROM_PCPF"}(d||(d={}));const h=L(),g=L(),_=x(),f=rn(),A=()=>En.getLogger("esri.geometry.support.meshUtils.vertexSpaceConversion");function tr(n,r,{vertexSpace:e,spatialReference:t}){if(e.type==="georeferenced"){const s=n;if(!Q(r,s,t))return!1;const{origin:p}=e;return dn(n,s,p),!0}const o=tn(t),l=n;if(!Q(r,l,o))return!1;const{origin:a}=e,i=H;if(!P(t,a,i,o))return!1;const c=v(H,i);return c!=null&&(Nn(n,l,c),!0)}function or(n,r,e){const{vertexSpace:t,transform:o,vertexAttributes:l}=n,a=Pn(t)?o:null,i=U(n.spatialReference,e,R.SOURCE_AND_TARGET);if(_n(t,r)&&(!a||un(a.localMatrix,en))&&w(i)){const{position:c,normal:s,tangent:p}=l,u=e?.allowBufferReuse;return{position:u?c:c.slice(),normal:u?s:s?.slice(),tangent:u?p:p?.slice()}}switch(n.vertexSpace.type){case"local":return r.type==="local"?Dn(n,n.vertexSpace,r.origin,e):$n(n,n.vertexSpace,r.origin,e);case"georeferenced":return r.type==="local"?bn(n,n.vertexSpace,r.origin,e):Un(n,n.vertexSpace,r.origin,e)}}function Un({vertexAttributes:n,transform:r,spatialReference:e},{origin:t},o,l){const a=U(e,l,R.SOURCE_AND_TARGET),i=t||!w(a)?cn(m,r?.localMatrix??en):null;i&&B(i,e,l,R.SOURCE_AND_TARGET);const{position:c,normal:s,tangent:p}=i?j(n,i):n,u=l?.allowBufferReuse,F=u?c:new Float64Array(c.length);let T=c;if(t&&(T=S(F,T,t)),o){const G=I(sn,o);T=S(F,T,G)}return{position:T!==n.position||u?T:T.slice(),normal:s!==n.normal||u?s:s?.slice(),tangent:p!==n.tangent||u?p:p?.slice()}}function k(n,r){return r?.useEllipsoid&&On(n)?Fn:tn(n)}function $n({spatialReference:n,vertexAttributes:r,transform:e},{origin:t},o,l){const a=k(n,l);if(!P(n,t,m,a))return y(A(),n,a),null;e&&$(m,m,e.localMatrix),B(m,n,l,R.SOURCE);const i=new Float64Array(r.position.length),c=Vn(r.position,m,n,i,a);if(!c)return null;const s=kn(c,n,i,a,r.normal,m);if(r.normal&&!s)return null;const p=jn(c,n,i,a,r.tangent,m);if(r.tangent&&!p)return null;if(o){const u=I(sn,o);S(c,c,u)}return{position:c,normal:s,tangent:p}}function bn({vertexAttributes:n,spatialReference:r,transform:e},{origin:t},o,l){const a=k(r,l);if(!P(r,o,m,a))return y(A(),r,a),null;const i=1/U(r,l,R.TARGET);K(m,m,[i,i,i]);const c=v(C,m),{position:s,normal:p,tangent:u}=Ln(n,t,e),F=new Float64Array(s.length),T=Bn(s,r,c,F,a);if(!T)return null;const G=b(qn,c),W=Wn(p,s,r,F,a,G,p!==n.normal?p:void 0);if(!W&&p)return null;const Y=Yn(u,s,r,F,a,G,u!==n.tangent?u:void 0);return!Y&&u?null:{position:T,normal:W,tangent:Y}}function Ln(n,r,e){if(!r)return n;if(!e){const{position:o,normal:l,tangent:a}=n;return{position:S(new Float64Array(o.length),o,r),tangent:a,normal:l}}const t=j(n,e.localMatrix);return S(t.position,t.position,r),t}function Dn({vertexAttributes:n,spatialReference:r,transform:e},{origin:t},o,l){const a=k(r,l);if(!P(r,t,m,a))return y(A(),r,a),null;if(e&&$(m,m,e.localMatrix),!P(r,o,C,a))return y(A(),a,r),null;v(C,C);const i=$(m,C,m);return B(i,r,l,R.SOURCE_AND_TARGET),j(n,i)}function j(n,r){const e=new Float64Array(n.position.length);D(e,n.position,r);const t=n.normal?new Float32Array(n.normal.length):null,o=n.tangent?new Float32Array(n.tangent.length):null;return t&&n.normal&&an(n.normal,t,r),o&&n.tangent&&ln(n.tangent,o,r),{position:e,normal:t,tangent:o}}function Vn(n,r,e,t,o){D(t,n,r);const l=new Float64Array(n.length);return hn(t,o,l,e)?l:(y(A(),o,e),null)}function kn(n,r,e,t,o,l){if(o==null)return null;const a=new Float32Array(o.length);return an(o,a,l),wn(a,n,r,e,t,a)?a:(y(A(),t,r),null)}function jn(n,r,e,t,o,l){if(o==null)return null;const a=new Float32Array(o.length);return ln(o,a,l),xn(a,n,r,e,t,a)?a:(y(A(),t,r),null)}function B(n,r,e,t){const o=U(r,e,t);w(o)||K(n,n,[o,o,o])}function U(n,r,e){const t=!!(e&R.SOURCE),o=!!(e&R.TARGET),l=r?.sourceUnit,a=r?.targetUnit;if(!l&&!a)return 1;let i=Z(l,n);t||!l||w(i)||(A().warn("source unit conversion not supported"),i=1);let c=1/Z(a,n);return o||!a||w(c)||(A().warn("target unit conversion not supported"),c=1),i*c}function w(n){return fn(n,1)}function Bn(n,r,e,t,o){const l=Gn(n,r,t,o);if(!l)return y(A(),r,o),null;const a=new Float64Array(l.length);return D(a,l,e),a}function Wn(n,r,e,t,o,l,a){if(n==null)return null;const i=a??new Float32Array(n.length);return Sn(n,r,e,t,o,i)?(V(i,i,l),i):(y(A(),e,o),null)}function Yn(n,r,e,t,o,l,a){if(n==null)return null;const i=a??new Float32Array(n.length);return vn(n,r,e,t,o,i)?(V(i,i,l,4),i):(y(A(),e,o),null)}function Z(n,r){if(n==null)return 1;const e=pn(r);return 1/mn(e,"meters",n)}const m=x(),C=x(),qn=rn(),sn=L(),H=x();var R;(function(n){n[n.NONE=0]="NONE",n[n.SOURCE=1]="SOURCE",n[n.TARGET=2]="TARGET",n[n.SOURCE_AND_TARGET=3]="SOURCE_AND_TARGET"})(R||(R={}));export{y as A,or as L,er as M,Z as Y,Gn as a,tr as b,vn as c,Sn as e,xn as f,hn as l,wn as o};
